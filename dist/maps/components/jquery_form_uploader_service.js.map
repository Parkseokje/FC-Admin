{"version":3,"sources":["components/jquery_form_uploader_service.js"],"names":["window","define","axios","self","extendOptions","options","this","fixUrl","url","JqueryFormUploaderService","prototype","XHR","percent","uploadedFileName","$","bar","XMLHttpRequest","percentVal","status","extend","a","key","b","hasOwnProperty","init","attr","validate","abort","on","e","cancelUpload","getUploadInfo","get","then","response","uploadUrl","deploy_package_id","data","replace","folder_id","uploadInfo","uploadCancelUrl","token","send","width","post","clearForm","console","log","alert","error","files","length","formData","Util","makeid","ajax","append","type","uploadFolder","contentType","fileToUpload","cache","beforeSend","xhr","upload","addEventListener","lengthComputable","Math","responseText","loaded","total","JSON","parse","html","modal","errorCode","success","pkg","val","callback","videoName","access_key","uploadDetail","errorInfo","errorMessage","send2"],"mappings":"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","file":"components/jquery_form_uploader_service.js","sourcesContent":["\"use strict\";\n\nwindow.define(\n  [\n    \"common\"\n    // 'jquery-form'\n  ],\n  function(Util) {\n    var self;\n    var $ = $ || window.$;\n    var axios = axios || window.axios;\n    var XHR = new window.XMLHttpRequest();\n    var uploadedFileName;\n\n    var bar = $(\".fileuploader-bar\");\n    var percent = $(\".fileuploader-percent\");\n    var status = $(\"#status\");\n    var percentVal = \"0%\";\n\n    function JqueryFormUploaderService(options) {\n      self = this;\n\n      self.extendOptions(options);\n      self.init();\n    }\n\n    function fixUrl(url) {\n      return (url = url.replace(/^http:\\/\\//i, \"https://\"));\n    }\n\n    JqueryFormUploaderService.prototype = {\n      // 옵션 저장 변수\n      options: {},\n      extend: function(a, b) {\n        for (var key in b) {\n          if (b.hasOwnProperty(key)) {\n            a[key] = b[key];\n          }\n        }\n        return a;\n      },\n      // 옵션 확장\n      extendOptions: function(options) {\n        this.options = this.extend({}, this.options);\n        this.extend(this.options, options);\n      },\n      // 컴포넌트 초기화\n      init: function() {\n        $(\"#cancel-button\").attr(\"disabled\", true);\n        $(\"#upload-button\").on(\"click\", function() {\n          if (!self.validate()) return false;\n\n          $(\"#upload-button\").attr(\"disabled\", true);\n          $(\"#cancel-button\").attr(\"disabled\", false);\n\n          self.getUploadInfo();\n        });\n        $(\"#cancel-button\").on(\"click\", function(e) {\n          XHR.abort();\n          self.cancelUpload();\n        });\n      },\n      // 업로드 정보를 요청한다.\n      getUploadInfo: function() {\n        axios.get(\"/api/v1/fineuploader/token\").then(function(response) {\n          var data = response.data;\n          if (data) {\n            // console.log(data);\n            self.options.uploadUrl = fixUrl(data.uploadInfo.uploadUrl.replace(\"v4\", \"cdnovp\"));\n            self.options.uploadCancelUrl = fixUrl(data.uploadInfo.uploadCancelUrl);\n            self.options.token = data.uploadInfo.token;\n            self.options.deploy_package_id = data.deploy_package_id;\n            self.options.folder_id = data.folder_id;\n\n            // 업로드 한다.\n            self.send();\n          }\n        });\n      },\n      clearForm: function() {\n        $(\"#upload-button\").attr(\"disabled\", false);\n        $(\"#cancel-button\").attr(\"disabled\", true);\n        $(\"#fileupload\").val(\"\");\n\n        percentVal = \"0%\";\n        bar.width(percentVal);\n        percent.html(percentVal);\n      },\n      // 업로드를 취소한다.\n      cancelUpload: function() {\n        axios\n          .post(self.options.uploadCancelUrl + \"?token=\" + self.options.token, {\n            token: self.options.token\n          })\n          .then(function(response) {\n            window.alert(\"업로드 취소\");\n\n            self.clearForm();\n          })\n          .catch(function(error) {\n            console.log(error);\n          });\n      },\n      validate: function() {\n        if ($(\"#fileupload\").get(0).files.length === 0) {\n          window.alert(\"파일을 선택하세요.\");\n          return false;\n        }\n\n        return true;\n      },\n      // 파일 업로드\n      // ref: https://stackoverflow.com/questions/166221/how-can-i-upload-files-asynchronously\n      send: function() {\n        var formData = new window.FormData();\n        var fileToUpload = $(\"#fileupload\").get(0).files[0];\n        uploadedFileName = Util.makeid() + \".mp4\";\n        // uploadedFileName = Util.makeid() + '.' + Util.getExtension(fileToUpload.name);\n\n        formData.append(\"token\", self.options.token);\n        formData.append(\"folder\", self.options.folder_id);\n        formData.append(\"pkg\", self.options.deploy_package_id);\n        formData.append(\"target_path\", self.options.uploadFolder);\n        formData.append(\"videofile\", fileToUpload, uploadedFileName);\n\n        $.ajax({\n          url: self.options.uploadUrl + \"?token=\" + self.options.token,\n          data: formData,\n          type: \"post\",\n          contentType: false,\n          processData: false,\n          cache: false,\n          beforeSend: function() {\n            status.empty();\n            percentVal = \"0%\";\n            bar.width(percentVal);\n            percent.html(percentVal);\n          },\n          xhr: function() {\n            if (XHR.upload) {\n              XHR.upload.addEventListener(\n                \"progress\",\n                function(e) {\n                  if (e.lengthComputable) {\n                    percentVal = Math.floor((e.loaded / e.total) * 100) + \"%\";\n                    bar.width(percentVal);\n                    percent.html(percentVal);\n                  }\n                },\n                false\n              );\n            }\n            return XHR;\n          },\n          success: function(responseText) {\n            var data = JSON.parse(responseText);\n\n            // console.log(data);\n\n            if (data.uploadInfo.errorInfo.errorCode === \"None\") {\n              percentVal = \"100%\";\n              bar.width(percentVal);\n              percent.html(percentVal);\n\n              window.alert(\"업로드 성공\");\n\n              self.clearForm();\n\n              $(\"#aqua-video-code\").val(\"onm_\" + uploadedFileName);\n              $(\"#fineUploader\").modal(\"hide\");\n\n              self.options.callback({\n                success: true,\n                videoName: uploadedFileName,\n                pkg: 1006241,\n                access_key: data.uploadInfo.uploadDetail.access_key,\n                token: self.options.token\n              });\n            } else {\n              window.alert(data.uploadInfo.errorInfo.errorMessage);\n            }\n\n            $(\"#upload-button\").attr(\"disabled\", false);\n            $(\"#cancel-button\").attr(\"disabled\", true);\n          }\n        });\n      },\n      send2: function() {\n        // var bar = $('.bar');\n        // var percent = $('.percent');\n        // var status = $('#status');\n        // var options = {\n        //   url: self.options.uploadUrl + '?token=' + self.options.token,\n        //   type: 'post',\n        //   dataType: 'json',\n        //   clearForm: true,\n        //   resetForm: true,\n        //   target: '#fileupload-form',\n        //   data: {\n        //     token: self.options.token,\n        //     folder: 2004661,\n        //     pkg: 1006241,\n        //     target_path: self.options.uploadFolder\n        //   },\n        //   // timeout: 3000,\n        //   beforeSerialize: function ($form, options) {\n        //     console.log($form);\n        //     console.log(options);\n        //     return true;\n        //   },\n        //   beforeSumbit: function (formData, jqForm, options) {\n        //     console.log(formData);\n        //     formData.set('videofile', $('#fileupload').get(0).files[0], '123.mp4');\n        //     return true;\n        //   },\n        //   beforeSend: function () {\n        //     status.empty();\n        //     var percentVal = '0%';\n        //     bar.width(percentVal);\n        //     percent.html(percentVal);\n        //   },\n        //   uploadProgress: function (event, position, total, percentComplete) {\n        //     var percentVal = percentComplete + '%';\n        //     bar.width(percentVal);\n        //     percent.html(percentVal);\n        //   },\n        //   success: function (responseText, statusText, xhr, $form) {\n        //     console.log(responseText);\n        //     var percentVal = '100%';\n        //     bar.width(percentVal);\n        //     percent.html(percentVal);\n        //   },\n        //   complete: function (xhr) {\n        //     status.html(xhr.responseText);\n        //   }\n        // };\n        // $('#fileupload-form').ajaxForm(options);\n      }\n    };\n\n    return JqueryFormUploaderService;\n  }\n);\n"],"sourceRoot":"/source/"}